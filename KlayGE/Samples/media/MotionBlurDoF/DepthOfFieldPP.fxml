<?xml version='1.0'?>

<effect>
	<include name="PostProcess.fxml"/>

	<parameter type="float4" name="mid_value" value="0.5"/>
		
	<cbuffer name="per_frame">
		<parameter type="float2" name="focus_plane_inv_range"/>
	</cbuffer>
	<parameter type="float4" name="sat_size"/>

	<parameter type="texture2D" name="src_tex"/>
	<parameter type="texture2D" name="sat_tex"/>

	<parameter type="sampler" name="point_sampler">
		<state name="filtering" value="min_mag_mip_point"/>
		<state name="address_u" value="clamp"/>
		<state name="address_v" value="clamp"/>
	</parameter>

	<shader>
		<![CDATA[
float BlurFactor(float2 tc)
{
	return saturate(abs(src_tex.Sample(point_sampler, tc).a - focus_plane_inv_range.x) * focus_plane_inv_range.y);
}

float4 DepthOfFieldPS(float2 tex_coord0 : TEXCOORD0) : SV_Target
{
	float4 clr;
	float blur_factor = BlurFactor(tex_coord0);

	int2 rect = clamp(blur_factor * 0.01f * sat_size.xy + 0.5f, 1, 8);
	float4 corner = (floor(tex_coord0 * sat_size.xy).xyxy + float4(rect - 1, -rect) + 0.5f) * sat_size.zwzw;
	float2 left_top = max(0.5f * sat_size.zw, corner.zw);
	float2 right_bottom = min(1 - 0.5f * sat_size.zw, corner.xy);
	float2 width_height = (right_bottom - left_top) * sat_size.xy;
	return (sat_tex.Sample(point_sampler, corner.xy) - sat_tex.Sample(point_sampler, corner.zy)
				- sat_tex.Sample(point_sampler, corner.xw) + sat_tex.Sample(point_sampler, corner.zw))
							/ (width_height.x * width_height.y) + mid_value;
}

float4 DepthOfFieldBlurFactorPS(float2 tex_coord0 : TEXCOORD0) : SV_Target
{
	return BlurFactor(tex_coord0);
}

float4 DepthOfFieldPassThroughPS(float2 tex_coord0 : TEXCOORD0) : SV_Target
{
	return src_tex.Sample(point_sampler, tex_coord0) + mid_value;
}
		]]>
	</shader>
	
	<technique name="DepthOfField">
		<pass name="p0">
			<state name="depth_enable" value="false"/>
			<state name="depth_write_mask" value="0"/>

			<state name="vertex_shader" value="PostProcessVS()"/>
			<state name="pixel_shader" value="DepthOfFieldPS()"/>
		</pass>
	</technique>

	<technique name="DepthOfFieldBlurFactor">
		<pass name="p0">
			<state name="depth_enable" value="false"/>
			<state name="depth_write_mask" value="0"/>

			<state name="vertex_shader" value="PostProcessVS()"/>
			<state name="pixel_shader" value="DepthOfFieldBlurFactorPS()"/>
		</pass>
	</technique>

	<technique name="DepthOfFieldPassThrough">
		<pass name="p0">
			<state name="depth_enable" value="false"/>
			<state name="depth_write_mask" value="0"/>

			<state name="vertex_shader" value="PostProcessVS()"/>
			<state name="pixel_shader" value="DepthOfFieldPassThroughPS()"/>
		</pass>
	</technique>
</effect>

FUNCTION(DOWNLOAD_7Z)
	IF(KLAYGE_HOST_PLATFORM_WINDOWS)
		DOWNLOAD_FILE("External/Downloads/${KLAYGE_HOST_PLATFORM_NAME}/7z.exe" "cbda47a1678ce70b6720856736100979d469e159")
		DOWNLOAD_FILE("External/Downloads/${KLAYGE_HOST_PLATFORM_NAME}/7z.dll" "cbda47a1678ce70b6720856736100979d469e159")
	ELSE()
		DOWNLOAD_FILE("External/Downloads/${KLAYGE_HOST_PLATFORM_NAME}/7z" "cbda47a1678ce70b6720856736100979d469e159")
		DOWNLOAD_FILE("External/Downloads/${KLAYGE_HOST_PLATFORM_NAME}/7z.so" "cbda47a1678ce70b6720856736100979d469e159")
		FILE(COPY "${KLAYGE_ROOT_DIR}/External/Downloads/${KLAYGE_PLATFORM_NAME}/7z" DESTINATION "${KLAYGE_ROOT_DIR}/External/Downloads")
		FILE(COPY "${KLAYGE_ROOT_DIR}/External/Downloads/7z" DESTINATION "${KLAYGE_ROOT_DIR}/External/Downloads/${KLAYGE_HOST_PLATFORM_NAME}/" FILE_PERMISSIONS OWNER_READ OWNER_WRITE OWNER_EXECUTE)
	ENDIF()
ENDFUNCTION()

FUNCTION(DOWNLOAD_PACKAGE PACKAGE_NAME RELATIVE_PATH COMMIT)
	GEN_FILE_ID_NAME(${RELATIVE_PATH} REL_FILE_ID)
	SET(REL_FILE_ID "${REL_FILE_ID}_UNPACKED")

	IF(NOT ((EXISTS ${KLAYGE_ROOT_DIR}/${RELATIVE_PATH}) AND ("${${REL_FILE_ID}}" STREQUAL ${COMMIT})))
		DOWNLOAD_7Z()
		DOWNLOAD_FILE(${RELATIVE_PATH} ${COMMIT})

		EXECUTE_PROCESS(COMMAND "${SEVENZIP_PATH}" "x" "-y" "${KLAYGE_ROOT_DIR}/${RELATIVE_PATH}" WORKING_DIRECTORY "${KLAYGE_ROOT_DIR}/External/${PACKAGE_NAME}")
		SET(${REL_FILE_ID} ${COMMIT} CACHE INTERNAL "" FORCE)
	ENDIF()
ENDFUNCTION()

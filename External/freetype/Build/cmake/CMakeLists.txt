PROJECT(freetype)

CMAKE_MINIMUM_REQUIRED(VERSION 2.8.6)

IF(COMMAND cmake_policy)
	CMAKE_POLICY(SET CMP0003 NEW)
ENDIF(COMMAND cmake_policy)

SET(FREETYPE_MAJOR_VERSION 2)
SET(FREETYPE_MINOR_VERSION 5)
SET(FREETYPE_PATCH_VERSION 0)
SET(FREETYPE_VERSION ${FREETYPE_MAJOR_VERSION}.${FREETYPE_MINOR_VERSION}.${FREETYPE_PATCH_VERSION})

FIND_PACKAGE(PythonInterp)

SET(FREETYPE_PROJECT_DIR "${CMAKE_CURRENT_SOURCE_DIR}/../..")
SET(KLAYGE_ROOT_DIR "${FREETYPE_PROJECT_DIR}/../..")

INCLUDE(${KLAYGE_ROOT_DIR}/cmake/Common.cmake)
INCLUDE(${KLAYGE_ROOT_DIR}/cmake/Platform.cmake)
INCLUDE(${KLAYGE_ROOT_DIR}/cmake/Compiler.cmake)

SET_PROPERTY(GLOBAL PROPERTY USE_FOLDERS ON)

SET(FREETYPE_OUTPUT_DIR "${FREETYPE_PROJECT_DIR}/objs/${KLAYGE_PLATFORM_NAME}")
SET(REL_PATH "External/Downloads/freetype-${FREETYPE_VERSION}.1.patched.7z")
SET(SEVENZIP_PATH "${KLAYGE_ROOT_DIR}/External/Downloads/${KLAYGE_PLATFORM_NAME}/7z")
SET(PACKAGE_COMMIT "d8e358e46d1cdbda70525b5dd05fd1ac722d58dd")

GEN_FILE_ID_NAME(${REL_PATH} REL_FILE_ID)
SET(REL_FILE_ID "${REL_FILE_ID}_UNPACKED")

IF(NOT ((EXISTS ${KLAYGE_ROOT_DIR}/${REL_PATH}) AND ("${${REL_FILE_ID}}" STREQUAL ${PACKAGE_COMMIT})))
	IF(KLAYGE_PLATFORM_WINDOWS)
		DOWNLOAD_FILE("External/Downloads/${KLAYGE_PLATFORM_NAME}/7z.exe" "cbda47a1678ce70b6720856736100979d469e159")
		DOWNLOAD_FILE("External/Downloads/${KLAYGE_PLATFORM_NAME}/7z.dll" "cbda47a1678ce70b6720856736100979d469e159")
	ELSE()
		DOWNLOAD_FILE("External/Downloads/${KLAYGE_PLATFORM_NAME}/7z" "cbda47a1678ce70b6720856736100979d469e159")
		DOWNLOAD_FILE("External/Downloads/${KLAYGE_PLATFORM_NAME}/7z.so" "cbda47a1678ce70b6720856736100979d469e159")
		FILE(COPY ${SEVENZIP_PATH} DESTINATION "${KLAYGE_ROOT_DIR}/External/Downloads")
		FILE(COPY "${KLAYGE_ROOT_DIR}/External/Downloads/7z" DESTINATION "${KLAYGE_ROOT_DIR}/External/Downloads/${KLAYGE_PLATFORM_NAME}" FILE_PERMISSIONS OWNER_READ OWNER_WRITE OWNER_EXECUTE)
	ENDIF()
	DOWNLOAD_FILE(${REL_PATH} ${PACKAGE_COMMIT})

	EXECUTE_PROCESS(COMMAND "${SEVENZIP_PATH}" "x" "-y" "${KLAYGE_ROOT_DIR}/${REL_PATH}" WORKING_DIRECTORY "${KLAYGE_ROOT_DIR}/External/freetype")
	SET(${REL_FILE_ID} ${PACKAGE_COMMIT} CACHE INTERNAL "" FORCE)	
ENDIF()

IF(MSVC)
	SET(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} /WX-")
	SET(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} /WX-")
ENDIF()

# The project settings

SET(LIB_NAME freetype)

SET(FREETYPE_FT_MODULES_SOURCE_FILES
	${FREETYPE_PROJECT_DIR}/src/base/ftbbox.c
	${FREETYPE_PROJECT_DIR}/src/base/ftgxval.c
	${FREETYPE_PROJECT_DIR}/src/base/ftlcdfil.c
	${FREETYPE_PROJECT_DIR}/src/base/ftmm.c
	${FREETYPE_PROJECT_DIR}/src/base/ftotval.c
	${FREETYPE_PROJECT_DIR}/src/base/ftpatent.c
	${FREETYPE_PROJECT_DIR}/src/base/ftpfr.c
	${FREETYPE_PROJECT_DIR}/src/base/ftsynth.c
	${FREETYPE_PROJECT_DIR}/src/base/fttype1.c
	${FREETYPE_PROJECT_DIR}/src/base/ftwinfnt.c
	${FREETYPE_PROJECT_DIR}/src/base/ftxf86.c
	${FREETYPE_PROJECT_DIR}/src/pcf/pcf.c
	${FREETYPE_PROJECT_DIR}/src/pfr/pfr.c
	${FREETYPE_PROJECT_DIR}/src/psaux/psaux.c
	${FREETYPE_PROJECT_DIR}/src/pshinter/pshinter.c
	${FREETYPE_PROJECT_DIR}/src/psnames/psmodule.c
	${FREETYPE_PROJECT_DIR}/src/raster/raster.c
	${FREETYPE_PROJECT_DIR}/src/sfnt/sfnt.c
	${FREETYPE_PROJECT_DIR}/src/truetype/truetype.c
	${FREETYPE_PROJECT_DIR}/src/type1/type1.c
	${FREETYPE_PROJECT_DIR}/src/cid/type1cid.c
	${FREETYPE_PROJECT_DIR}/src/type42/type42.c
	${FREETYPE_PROJECT_DIR}/src/winfonts/winfnt.c
)
SET(FREETYPE_SOURCE_FILES
	${FREETYPE_PROJECT_DIR}/src/autofit/autofit.c
	${FREETYPE_PROJECT_DIR}/src/bdf/bdf.c
	${FREETYPE_PROJECT_DIR}/src/cff/cff.c
	${FREETYPE_PROJECT_DIR}/src/base/ftbase.c
	${FREETYPE_PROJECT_DIR}/src/base/ftbitmap.c
	${FREETYPE_PROJECT_DIR}/src/cache/ftcache.c
	${FREETYPE_PROJECT_DIR}/builds/win32/ftdebug.c
	${FREETYPE_PROJECT_DIR}/src/base/ftfstype.c
	${FREETYPE_PROJECT_DIR}/src/base/ftgasp.c
	${FREETYPE_PROJECT_DIR}/src/base/ftglyph.c
	${FREETYPE_PROJECT_DIR}/src/gzip/ftgzip.c
	${FREETYPE_PROJECT_DIR}/src/base/ftinit.c
	${FREETYPE_PROJECT_DIR}/src/lzw/ftlzw.c
	${FREETYPE_PROJECT_DIR}/src/base/ftstroke.c
	${FREETYPE_PROJECT_DIR}/src/base/ftsystem.c
	${FREETYPE_PROJECT_DIR}/src/smooth/smooth.c
)
SET(FREETYPE_HEADER_FILES
	${FREETYPE_PROJECT_DIR}/include/ft2build.h
	${FREETYPE_PROJECT_DIR}/include/freetype/config/ftconfig.h
	${FREETYPE_PROJECT_DIR}/include/freetype/config/ftheader.h
	${FREETYPE_PROJECT_DIR}/include/freetype/config/ftmodule.h
	${FREETYPE_PROJECT_DIR}/include/freetype/config/ftoption.h
	${FREETYPE_PROJECT_DIR}/include/freetype/config/ftstdlib.h
)
SOURCE_GROUP("Source Files" FILES ${FREETYPE_SOURCE_FILES})
SOURCE_GROUP("Source Files\\FT_MODULES" FILES ${FREETYPE_FT_MODULES_SOURCE_FILES})
SOURCE_GROUP("Header Files" FILES ${FREETYPE_HEADER_FILES})

ADD_DEFINITIONS(-DFT2_BUILD_LIBRARY)
IF (MSVC)
	ADD_DEFINITIONS(-D_CRT_SECURE_NO_WARNINGS)
	SET(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} /DFT_DEBUG_LEVEL_ERROR /DFT_DEBUG_LEVEL_TRACE")
ENDIF()

INCLUDE_DIRECTORIES(${FREETYPE_PROJECT_DIR}/include)
ADD_LIBRARY(${LIB_NAME} STATIC
	${FREETYPE_FT_MODULES_SOURCE_FILES} ${FREETYPE_SOURCE_FILES} ${FREETYPE_HEADER_FILES}
)

SET(LIB_OUTPUT_NAME ${LIB_NAME}${FREETYPE_MAJOR_VERSION}${FREETYPE_MINOR_VERSION}${FREETYPE_PATCH_VERSION})

SET_TARGET_PROPERTIES(${LIB_NAME} PROPERTIES
	ARCHIVE_OUTPUT_DIRECTORY ${FREETYPE_OUTPUT_DIR}
	ARCHIVE_OUTPUT_DIRECTORY_DEBUG ${FREETYPE_OUTPUT_DIR}
	ARCHIVE_OUTPUT_DIRECTORY_RELEASE ${FREETYPE_OUTPUT_DIR}
	ARCHIVE_OUTPUT_DIRECTORY_RELWITHDEBINFO ${FREETYPE_OUTPUT_DIR}
	ARCHIVE_OUTPUT_DIRECTORY_MINSIZEREL ${FREETYPE_OUTPUT_DIR}
	PROJECT_LABEL ${LIB_NAME}
	DEBUG_POSTFIX ${CMAKE_DEBUG_POSTFIX}
	OUTPUT_NAME ${LIB_OUTPUT_NAME}${KLAYGE_OUTPUT_SUFFIX}
)

TARGET_LINK_LIBRARIES(${LIB_NAME})
